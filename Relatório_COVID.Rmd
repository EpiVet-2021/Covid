---
title: "Análise da Evolução do COVID"
author: "Helena Salgueiro, Mafalda Gomes, Margarida Caravela e Sara Cardoso"
date: "Outubro, 2021"
output:
  html_document:
    theme: paper
    highlight: zenburn
    df_print: paged
---

<style type="text/css">

body {
text-align: justify}
</style>

```{css, echo=FALSE}
/* Whole document: */
body{
  font-size: 12pt ;
}
```
***

### **Introdução**

O SARS-CoV-2 é um novo coronavírus que saltou a barreira entre espécies. Quer isto dizer que este vírus foi transmitido ao Homem a partir de um animal reservatório ou hospedeiro desse mesmo vírus. A doença por ele originada é designada por COVID-19 e foi identificada pela primeira vez em dezembro de 2019, na China. [^1]

[^1]: DGS: Perguntas frequentes [Internet]. 2021. [acedido em 2021 Out 6]. https://covid19.min-saude.pt/category/perguntas-frequentes/

Neste relatório, pretendemos avaliar a situação epidemiológica relativa a esta doença em Portugal desde o início da pandemia, com base nos dados do site: <https://github.com/dssg-pt/covid19pt-data>.

Este relatório vai interpretar os seguintes pontos:
<ul>
  <li>evolução dos casos diários</li>
  <li>evolução dos casos de doença grave</li>
  <li>eficácia da vacinação po grupo etário</li>
  <ul>
     <li>vacinas administradas</li>
     <li>recuperação após vacinação</li>
     </ul>
  <li>transmissibilidade do vírus (R(t))</li>
</ul>


```{r bibliotecas, include = FALSE}
# Libraries
library(RCurl)
library(ggplot2)
library(plotly)
require(rmarkdown)
library(leaflet)
library(zoo)
library(tidyverse)
library(lubridate)
library(fpp2)
library(dplyr)
library(devtools)
library(rgdal)

```


```{r base de dados, include=FALSE}

# Abrir base de dados
x <- getURL("https://raw.githubusercontent.com/dssg-pt/covid19pt-data/master/data.csv")
data_covid <- read.csv(text = x)

w <- getURL("https://raw.githubusercontent.com/dssg-pt/covid19pt-data/master/vacinas.csv")
data_vacina <- read.csv(text = w)

```


```{r manipulação de dados, include=FALSE}

# Alterar formato character para formato data
data_covid$data2 <- as.Date(data_covid$data, format = "%d-%m-%Y")
data_vacina$data2 <- as.Date(data_vacina$data, format = "%d-%m-%Y")

# Alterar valores negativos para evitar erro à frente
data_covid[425, 23:40] = data_covid[424, 23:40]

# Novas colunas com a soma dos femininos e masculinos
data_covid$confirmados_0_9 <- data_covid$confirmados_0_9_f + data_covid$confirmados_0_9_m
data_covid$confirmados_10_19 <- data_covid$confirmados_10_19_f + data_covid$confirmados_10_19_m
data_covid$confirmados_20_29 <- data_covid$confirmados_20_29_f + data_covid$confirmados_20_29_m
data_covid$confirmados_30_39 <- data_covid$confirmados_30_39_f + data_covid$confirmados_30_39_m
data_covid$confirmados_40_49 <- data_covid$confirmados_40_49_f + data_covid$confirmados_40_49_m
data_covid$confirmados_50_59 <- data_covid$confirmados_50_59_f + data_covid$confirmados_50_59_m
data_covid$confirmados_60_69 <- data_covid$confirmados_60_69_f + data_covid$confirmados_60_69_m
data_covid$confirmados_70_79 <- data_covid$confirmados_70_79_f + data_covid$confirmados_70_79_m
data_covid$confirmados_80_plus <- data_covid$confirmados_80_plus_f + data_covid$confirmados_80_plus_m

# Usamos a função diff(as.matrix(df)) que nos vai dar a diferença entre as linhas de uma data frame, das colunas que quisermos se no sitio da df pusermos so as colunas que nos interessam.

# Criar uma nova tabela em que apenas usamos a primeira linha das colunas que nos interessam, e depois criar outra em que usamos a formula para obter uma tabela só com os casos novos por faixa etária.
casos_novos <- data_covid[1, c(94, 95, 96, 97, 98, 99, 100, 101, 102, 103)]
casos_novos2 <- data.frame(diff(as.matrix(data_covid[,c(95, 96, 97, 98, 99, 100, 101, 102, 103)])))

# Unir a coluna data da data frame original à nova tabela dos casos novos 2 por faixa etária.
casos_novos2 <- cbind(data_covid[2:593, 94], casos_novos2)

# Mudar os nomes das colunas.
colnames(casos_novos2) <- c("Data2", "Casos_novos_0_9", "Casos_novos_10_19", "Casos_novos_20_29", "Casos_novos_30_39", "Casos_novos_40_49", "Casos_novos_50_59", "Casos_novos_60_69", "Casos_novos_70_79", "Casos_novos_80_plus")
colnames(casos_novos) <- c("Data2", "Casos_novos_0_9", "Casos_novos_10_19", "Casos_novos_20_29", "Casos_novos_30_39", "Casos_novos_40_49", "Casos_novos_50_59", "Casos_novos_60_69", "Casos_novos_70_79", "Casos_novos_80_plus")

# Juntar as linhas das duas novas tabelas, para termos a tabela completa com o primeiro dia, e unimos depois a coluna dos novos confirmados totais da tabela original.
casos_novos <- rbind(casos_novos, casos_novos2)
casos_novos <- cbind(casos_novos$Data2, data_covid$confirmados_novos, casos_novos[, 2:10])

# Voltar a por nomes corretos.
colnames(casos_novos) <- c("Data2", "Confirmados_novos", "Casos_novos_0_9", "Casos_novos_10_19", "Casos_novos_20_29", "Casos_novos_30_39", "Casos_novos_40_49", "Casos_novos_50_59", "Casos_novos_60_69", "Casos_novos_70_79", "Casos_novos_80_plus")

# Passar os valores de novos casos para percentagem, caso seja necessário posteriormente.
casos_novos$perc_novos_0_9 <- (casos_novos$Casos_novos_0_9 / casos_novos$Confirmados_novos) * 100
casos_novos$perc_novos_10_19 <- (casos_novos$Casos_novos_10_19 / casos_novos$Confirmados_novos) * 100
casos_novos$perc_novos_20_29 <- (casos_novos$Casos_novos_20_29 / casos_novos$Confirmados_novos) * 100
casos_novos$perc_novos_30_39 <- (casos_novos$Casos_novos_30_39 / casos_novos$Confirmados_novos) * 100
casos_novos$perc_novos_40_49 <- (casos_novos$Casos_novos_40_49 / casos_novos$Confirmados_novos) * 100
casos_novos$perc_novos_50_59 <- (casos_novos$Casos_novos_50_59 / casos_novos$Confirmados_novos) * 100
casos_novos$perc_novos_60_69 <- (casos_novos$Casos_novos_60_69 / casos_novos$Confirmados_novos) * 100
casos_novos$perc_novos_70_79 <- (casos_novos$Casos_novos_70_79 / casos_novos$Confirmados_novos) * 100
casos_novos$perc_novos_80_plus <- (casos_novos$Casos_novos_80_plus / casos_novos$Confirmados_novos) * 100

# Fazer média rolante de todas as colunas para deixarmos de ter valores negativos e picos tão acentuados.
casos_novos$Rollmean_0_9 <- rollmean(casos_novos$Casos_novos_0_9, k = 7, "center", fill = NA)
casos_novos$Rollmean_10_19 <- rollmean(casos_novos$Casos_novos_10_19, k = 7, "center", fill = NA)
casos_novos$Rollmean_20_29 <- rollmean(casos_novos$Casos_novos_20_29, k = 7, "center", fill = NA)
casos_novos$Rollmean_30_39 <- rollmean(casos_novos$Casos_novos_30_39, k = 7, "center", fill = NA)
casos_novos$Rollmean_40_49 <- rollmean(casos_novos$Casos_novos_40_49, k = 7, "center", fill = NA)
casos_novos$Rollmean_50_59 <- rollmean(casos_novos$Casos_novos_50_59, k = 7, "center", fill = NA)
casos_novos$Rollmean_60_69 <- rollmean(casos_novos$Casos_novos_60_69, k = 7, "center", fill = NA)
casos_novos$Rollmean_70_79 <- rollmean(casos_novos$Casos_novos_70_79, k = 7, "center", fill = NA)
casos_novos$Rollmean_80_plus <- rollmean(casos_novos$Casos_novos_80_plus, k = 7, "center", fill = NA)

casos_novos$Rollmean_perc_0_9 <- rollmean(casos_novos$perc_novos_0_9, k = 7, "center", fill = NA)
casos_novos$Rollmean_perc_10_19 <- rollmean(casos_novos$perc_novos_10_19, k = 7, "center", fill = NA)
casos_novos$Rollmean_perc_20_29 <- rollmean(casos_novos$perc_novos_20_29, k = 7, "center", fill = NA)
casos_novos$Rollmean_perc_30_39 <- rollmean(casos_novos$perc_novos_30_39, k = 7, "center", fill = NA)
casos_novos$Rollmean_perc_40_49 <- rollmean(casos_novos$perc_novos_40_49, k = 7, "center", fill = NA)
casos_novos$Rollmean_perc_50_59 <- rollmean(casos_novos$perc_novos_50_59, k = 7, "center", fill = NA)
casos_novos$Rollmean_perc_60_69 <- rollmean(casos_novos$perc_novos_60_69, k = 7, "center", fill = NA)
casos_novos$Rollmean_perc_70_79 <- rollmean(casos_novos$perc_novos_70_79, k = 7, "center", fill = NA)
casos_novos$Rollmean_perc_80_plus <- rollmean(casos_novos$perc_novos_80_plus, k = 7, "center", fill = NA)

```


<br>

### **Análise dos dados**

<br>

#### **Evolução dos casos diários**

Para analisar a evolução dos casos diários utilizamos as colunas 23 a 40, com os valores de casos confirmados femininos e masculinos para cada faixa etária. Uma vez que estes números aparentam ser cumulativos, criamos novas colunas com a soma dos femininos e masculinos e ainda a diferença de valores da linha anterior, passanod tudo para uma tabela nova com os valores de interesse para esta parte da análise.
A base de dados utilizada inclui informação desde o dia 26 de Fevereiro de 2020, atualizando todos os dias.

<br>

```{r, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE, dpi=80, fig.align="center"}

# Fazer scatter plotly mas com os valores médios da rollmean.
fig <- plot_ly(casos_novos, x = casos_novos$Data2, y = casos_novos$Rollmean_perc_0_9, name = '0-9', type = 'scatter', mode = 'none', stackgroup = 'one', groupnorm = 'percent', fillcolor = '#5f9ea0')
fig <- fig %>% add_trace(y = casos_novos$Rollmean_perc_10_19, name = '10-19', fillcolor = '#deb887')
fig <- fig %>% add_trace(y = casos_novos$Rollmean_perc_20_29, name = '20-29', fillcolor = '#cd5b45')
fig <- fig %>% add_trace(y = casos_novos$Rollmean_perc_30_39, name = '30-39', fillcolor = '#ffb90f')
fig <- fig %>% add_trace(y = casos_novos$Rollmean_perc_40_49, name = '40-49', fillcolor = '#6495ed')
fig <- fig %>% add_trace(y = casos_novos$Rollmean_perc_50_59, name = '50-59', fillcolor = '#e9967a')
fig <- fig %>% add_trace(y = casos_novos$Rollmean_perc_60_69, name = '60-69', fillcolor = '#6e8b3d')
fig <- fig %>% add_trace(y = casos_novos$Rollmean_perc_70_79, name = '70-79', fillcolor = '#7b68ee')
fig <- fig %>% add_trace(y = casos_novos$Rollmean_perc_80_plus, name = '80+', fillcolor = '#ffe4e1')
fig <- fig %>% layout(title = 'Evolução percentual de casos novos por grupo etário', 
                      xaxis = list(title = "Data", 
                                   showgrid = FALSE), 
                      yaxis = list(title = "%", 
                                   showgrid = FALSE, 
                                   ticksuffix = '%'),
                      paper_bgcolor = "#ffffff",
                      plot_bgcolor = "#ffffff"
                      )
fig
```
<br>

#### **Casos por administração regional de saúde**

```{r include=FALSE, warning=FALSE, message=FALSE, fig.align="center"}

# CRIAR ARS COM SHAPEFILES DOS POLIGONOS CRIADOS NO GEOJSON
ARS_norte <- readOGR(dsn = path.expand("/Users/SofiaSalgueiro/Desktop/EpiVet/TRABALHOS/3. Análise Covid/Shapefiles polígonos/ARS Norte shapefile/POLYGON.shp"))
ARS_centro <- readOGR(dsn = path.expand("/Users/SofiaSalgueiro/Desktop/EpiVet/TRABALHOS/3. Análise Covid/Shapefiles polígonos/ARS Centro shapefile/POLYGON.shp"))
ARS_lvt <- readOGR(dsn = path.expand("/Users/SofiaSalgueiro/Desktop/EpiVet/TRABALHOS/3. Análise Covid/Shapefiles polígonos/ARS LVT shapefile/POLYGON.shp"))
ARS_alentejo <- readOGR(dsn = path.expand("/Users/SofiaSalgueiro/Desktop/EpiVet/TRABALHOS/3. Análise Covid/Shapefiles polígonos/ARS Alentejo shapefile/POLYGON.shp"))
ARS_algarve <- readOGR(dsn = path.expand("/Users/SofiaSalgueiro/Desktop/EpiVet/TRABALHOS/3. Análise Covid/Shapefiles polígonos/ARS Algarve shapefile/POLYGON.shp"))
Madeira <- readOGR(dsn = path.expand("/Users/SofiaSalgueiro/Desktop/EpiVet/TRABALHOS/3. Análise Covid/Shapefiles polígonos/Madeira shapefile/POLYGON.shp"))
Acores <- readOGR(dsn = path.expand("/Users/SofiaSalgueiro/Desktop/EpiVet/TRABALHOS/3. Análise Covid/Shapefiles polígonos/Açores shapefile/POLYGON.shp"))


# Nova tabela com os casos por ARS.
data_covid$data2 <- as.Date(data_covid$data, format = "%d-%m-%Y")
casos_ARS <- data_covid[,c(4:10)]
casos_ARS <- cbind(data_covid$data2, casos_ARS)

colnames(casos_ARS) <- c("Data", "confirmados_ARSNorte", "confirmados_ARSCentro", "confirmados_ARSlvt", "confirmados_ARSAlentejo", "confirmados_ARSAlgarve", "confirmados_acores", "confirmados_madeira")


# Criar palete para criar legenda posteriormente
pal <- colorFactor(palette = c("#5f9ea0", "#cd5c5c", "#8b7e66", "#556b2f", "#ee7942"), levels = c("1. ARS Norte", "2. ARS Centro", "3. ARS Lisboa e Vale do Tejo", "4. ARS Alentejo", "5. ARS Algarve"))

```



```{r include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Casos confirmados cumulativos de covid por administração regional de saúde."}

# Criar mapa leaflet com os polígonos _________________________________________
mapa_ARS <- leaflet() %>% 
  addTiles() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  setView(lng = -7.733, lat = 40.255, zoom = 6) %>% 
  addPolygons(data = ARS_norte,
              color = "#5f9ea0",
              opacity = 0.5,
              label = "ARS Norte") %>% 
  addLabelOnlyMarkers(-7.718, 41.406, label = "412177",
                      labelOptions = labelOptions(noHide = T, direction = 'center', textOnly = T, style = list("color" = "black", "font-family" = "helvetica", "box-shadow" = "3px 3px rgba(0,0,0,0.25)", "font-size" = "10px", "border-color" = "rgba(0,0,0,0.5)"))) %>% 
  addPolygons(data = ARS_centro,
              color = "#cd5c5c",
              opacity = 0.5,
              label = "ARS Centro") %>%
  addLabelOnlyMarkers(-7.833, 40.255, label = "143786",
                      labelOptions = labelOptions(noHide = T, direction = 'center', textOnly = T, style = list("color" = "black", "font-family" = "helvetica", "box-shadow" = "3px 3px rgba(0,0,0,0.25)", "font-size" = "10px", "box-color" = "gray", "border-color" = "rgba(0,0,0,0.5)"))) %>% 
  addPolygons(data = ARS_lvt,
              color = "#8b7e66",
              opacity = 0.5,
              label = "ARS Lisboa e Vale do Tejo") %>% 
  addLabelOnlyMarkers(-8.798, 39.136, label = "415419",
                      labelOptions = labelOptions(noHide = T, direction = 'center', textOnly = T, style = list("color" = "black", "font-family" = "helvetica", "box-shadow" = "3px 3px rgba(0,0,0,0.25)", "font-size" = "10px", "box-color" = "gray", "border-color" = "rgba(0,0,0,0.5)"))) %>% 
  addPolygons(data = ARS_alentejo,
              color = "#556b2f",
              opacity = 0.5,
              label = "ARS Alentejo") %>% 
  addLabelOnlyMarkers(-7.974, 38.261, label = "39438",
                      labelOptions = labelOptions(noHide = T, direction = 'center', textOnly = T, style = list("color" = "black", "font-family" = "helvetica", "box-shadow" = "3px 3px rgba(0,0,0,0.25)", "font-size" = "10px", "box-color" = "gray", "border-color" = "rgba(0,0,0,0.5)"))) %>% 
  addPolygons(data = ARS_algarve,
              color = "#ee7942",
              opacity = 0.5,
              label = "ARS Algarve") %>% 
  addLabelOnlyMarkers(-8.134, 37.180, label = "43090",
                      labelOptions = labelOptions(noHide = T, direction = 'center', textOnly = T, style = list("color" = "black", "font-family" = "helvetica", "box-shadow" = "3px 3px rgba(0,0,0,0.25)", "font-size" = "10px", "box-color" = "gray", "border-color" = "rgba(0,0,0,0.5)"))) %>%  
  addLegend("bottomright", pal = pal, 
            values = c("1. ARS Norte", "2. ARS Centro", "3. ARS LVT", "4. ARS Alentejo", "5. ARS Algarve"),
            title = "ARS",
            opacity = 1)
mapa_ARS

```

<br>

```{r include=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Casos confirmados cumulativos de covid na região dos Açores."}

# Criar mapas dos açores _____________________________________________________
mapa_acores <- leaflet() %>% addTiles() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  setView(lng = -28.20, lat = 38.47, zoom = 7) %>% 
  addPolygons(data = Acores,
              color = "#eeb422",
              opacity = 0.5,
              label = "Açores") %>% 
  addLabelOnlyMarkers(-28.35, 38.47, label = "9017",
                      labelOptions = labelOptions(noHide = T, direction = 'center', textOnly = T, style = list("color" = "black", "font-family" = "helvetica", "box-shadow" = "3px 3px rgba(0,0,0,0.25)", "font-size" = "10px", "box-color" = "gray", "border-color" = "rgba(0,0,0,0.5)")))

mapa_acores

```

<br>

```{r include=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Casos confirmados cumulativos de covid na região da Madeira."}

# Criar mapas da madeira _____________________________________________________
mapa_madeira <- leaflet() %>% addTiles() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  setView(lng = -17.025, lat = 32.730, zoom = 8) %>%
  addPolygons(data = Madeira,
              color = "#483d8b",
              opacity = 0.5,
              label = "Madeira") %>% 
  addLabelOnlyMarkers(-17.025, 32.730, label = "12385",
                      labelOptions = labelOptions(noHide = T, direction = 'center', textOnly = T, style = list("color" = "black", "font-family" = "helvetica", "box-shadow" = "3px 3px rgba(0,0,0,0.25)", "font-size" = "10px", "box-color" = "gray", "border-color" = "rgba(0,0,0,0.5)")))

mapa_madeira

```


<br>

#### **Evolução dos casos de doença grave**

Para analisar a evolução dos casos graves, utilizamos as colunas correspondentes aos internados da base de dados. Estas colunas incluem as pessoas que foram internadas na UCi e na enfermaria.

<br>

```{r include=TRUE, echo=FALSE, message=FALSE, warning=FALSE, dpi=80, fig.align="center"}

fig2 <- plot_ly(data_covid, x = ~data2, y = ~internados, name = 'Internados', type = 'scatter', mode = 'lines', color = '#2vd1fc')
fig2 <- fig2 %>% add_trace(y = ~internados_uci, name = 'Internados UCI', color = '#2vd1fd')
fig2 <- fig2 %>% add_trace(y = ~internados_enfermaria, name = 'Internados Enfermaria', color = '#ffff00')
fig2 <-fig2 %>% layout(title= "Evolução de Casos em Doentes Internados", 
                       font=list(family = "helvetica", size = 13, color = '#1a1a1a'), 
                       xaxis = list(title = "Data", 
                                    showgrid=F, 
                                    showline=F, 
                                    zerolinecolor = '#1a1a1a'), 
                       yaxis = list(title = "Nº Pessoas Internadas", 
                                    showline= F,  
                                    zerolinecolor = '#1a1a1a'), 
                       paper_bgcolor='#ffffff', 
                       plot_bgcolor='#ffffff')
fig2
```


<br>

#### **Eficácia da vacinação por grupo etário**

A vacinação contra a COVID-19 surge como uma resposta central para controlar a pandemia. Tem o objetivo de prevenir o aparecimento de doença grave e das suas consequências, de forma a reduzir a pressão exercida sobre o sistema nacional de saúde. Um indivíduo vacinado só se encontra protegido da doença uma a duas semanas após a vacinação completa. Este é o período que dá garantia de uma resposta robusta por parte do seu sistema imunitário. Ainda se desconhece se a vacinação impede a infeção assintomática. Ou seja, as vacinas conferem proteção contra a doença, mas não protegem necessariamente outras pessoas caso sejamos “portadores” e transmissor do vírus, sem exibir sintomas. As máscaras e o distanciamento evitam que possamos infetar outras pessoas caso sejamos “portadores” do vírus sem saber. Neste momento, não é possível avaliar por quanto tempo a proteção que a vacinação confere se irá manter, nem se haverá necessidade de administrar uma dose de reforço e qual a sua periodicidade.[^2]

[^2]: DGS: Vacinação | Perguntas frequentes [Internet]. 2021. [acedido em 2021 Out 6]. https://covid19.min-saude.pt/perguntas-frequentes/


```{r, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}

graf <- plot(x = data_vacina$data2, y = data_vacina$pessoas_vacinadas_completamente, type = "l", col = 'thistle4', lwd = 1, main = "Evolução do n.º de indivíduos vacina (valores acumulados)", col.main = 'plum4', xlab = "Data", ylab = "N.º de indivíduos") + 
  abline(h=8840000, col="deeppink3")

```


Portugal é constituído, aproximadamente por 10 400 000 habitantes [^3]. Assim, tendo em conta que os estudos apontam para a necessidade de 85% da população vacinada para a obtenção de imunidade de grupo [^4], verifica-se que o valor pretendido está quase a ser alcançado.

[^3]: Expresso [Internet]. [acedido em 2021 Out 7]. https://expresso.pt/sociedade/2021-07-28-Censos-2021.-Populacao-portuguesa-diminuiu-2-em-10-anos-metade-concentra-se-em-31-concelhos-de-Lisboa-e-Porto-846aded9

[^4]: OE [Internet]. [acedido em 2021 Out 7]. https://www.ordemenfermeiros.pt/noticias/conteudos/oe-alerta-que-imunidade-de-grupo-s%C3%B3-se-atinge-com-85-da-popula%C3%A7%C3%A3o-vacinada-e-est%C3%A1-contra-fim-da-m%C3%A1scara-em-outubro/

<br>


